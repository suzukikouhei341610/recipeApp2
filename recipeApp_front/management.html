<!DOCTYPE html>
<html>
<head>
    <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font@6.x/css/materialdesignicons.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.min.css" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">
    <meta charset="UTF-8">
    <title>Management</title>
</head>
<body>
    <div id="app">
        <v-app>
            <v-main>
                <v-container>
                    <v-card v-if="selectedRecipe" class="mb-5">
                        <v-card-title>レシピ詳細</v-card-title>
                        <v-card-text>
                            <v-row>
                                <v-col cols="12" md="6">
                                    <div>
                                        <p v-if="selectedRecipe.recipe_id">ID: {{ selectedRecipe.recipe_id }}</p>
                                        <p v-if="selectedRecipe.recipe_name">レシピ名: {{ selectedRecipe.recipe_name }}</p>
                                        <p v-if="selectedRecipe.recipe_category1">カテゴリー1: {{ selectedRecipe.recipe_category1 }}</p>
                                        <p v-if="selectedRecipe.recipe_category2">カテゴリー2: {{ selectedRecipe.recipe_category2 }}</p>
                                        <p v-if="selectedRecipe.recipe_category3">カテゴリー3: {{ selectedRecipe.recipe_category3 }}</p>
                                        <p v-if="selectedRecipe.recipe_time">調理時間: {{ selectedRecipe.recipe_time }} 分</p>
                                        <p v-if="selectedRecipe.recipe_scene1">シーン1: {{ selectedRecipe.recipe_scene1 }}</p>
                                        <p v-if="selectedRecipe.recipe_scene2">シーン2: {{ selectedRecipe.recipe_scene2 }}</p>
                                        <p v-if="selectedRecipe.recipe_scene3">シーン3: {{ selectedRecipe.recipe_scene3 }}</p>
                                        <p v-if="selectedRecipe.recipe_item1">商品1: {{ selectedRecipe.recipe_item1 }}</p>
                                        <p v-if="selectedRecipe.recipe_item2">商品2: {{ selectedRecipe.recipe_item2 }}</p>
                                        <p v-if="selectedRecipe.recipe_item3">商品3: {{ selectedRecipe.recipe_item3 }}</p>
                                    </div>
                                </v-col>
                                <v-col cols="12" md="3">
                                    <v-img v-if="selectedRecipe.recipe_photo" :src="selectedRecipe.recipe_photo" alt="レシピ写真" max-width="100%"></v-img>
                                </v-col>
                            </v-row>
                        </v-card-text>
                        <v-card-actions>
                            <v-btn color="blue" @click="goBack">戻る</v-btn>
                            <v-btn color="red" @click="confirmDelete(selectedRecipe)">削除</v-btn>
                        </v-card-actions>
                    </v-card>

                    <v-dialog v-model="showMessageDialog" max-width="400">
                        <v-card>
                            <v-card-title class="headline">通知</v-card-title>
                            <v-card-text>
                                {{ message }}
                            </v-card-text>
                            <v-card-actions>
                                <v-spacer></v-spacer>
                                <v-btn color="blue" text @click="closeMessageDialog">閉じる</v-btn>
                            </v-card-actions>
                        </v-card>
                    </v-dialog>
                    
                    <v-card v-if="!selectedRecipe">
                        <v-card-title>レシピ管理</v-card-title>
                        <v-card-text>
                            <v-data-table
                                :headers="headers"
                                :items="recipes"
                                item-key="recipe_id"
                                class="elevation-1"
                                @click:row="selectRecipe"
                            >
                                <template v-slot:item.recipe_photo="{ item }">
                                    <v-img :src="item.recipe_photo" max-width="100" contain></v-img>
                                </template>
                                <template v-slot:item.actions="{ item }">
                                    <v-btn color="red" @click="confirmDelete(item)">削除</v-btn>
                                </template>
                            </v-data-table>
                        </v-card-text>
                    </v-card>

                    <v-dialog v-model="dialog" max-width="500px">
                        <v-card>
                            <v-card-title>削除確認</v-card-title>
                            <v-card-text>
                                本当にこのレシピを削除しますか？<br>
                                削除したレシピは完全に消去されます。
                            </v-card-text>
                            <v-card-actions>
                                <v-spacer></v-spacer>
                                <v-btn color="blue darken-1" text @click="dialog = false">キャンセル</v-btn>
                                <v-btn color="red" text @click="deleteRecipe">削除</v-btn>
                            </v-card-actions>
                        </v-card>
                    </v-dialog>
                </v-container>
            </v-main>
        </v-app>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/vue@2.x/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        new Vue({
            el: '#app',
            vuetify: new Vuetify(),
            data() {
                return {
                    recipes: [],
                    selectedRecipe: null,
                    dialog: false,
                    headers: [
                        { text: 'レシピID', value: 'recipe_id' },
                        { text: 'レシピ名', value: 'recipe_name' },
                        { text: 'レシピ写真', value: 'recipe_photo' }
                    ],
                    dialog: false,
                    selectedRecipe: null,
                    message: '',
                    showMessageDialog: false,
                };
            },
            mounted() {
                this.selectRecipes();
            },
            methods: {
                async selectRecipes() {
                    try {
                        const response = await axios.get('https://m3h-kouhei-2010.azurewebsites.net/api/RECIPESELECT');
                        console.log('APIレスポンス:', response.data);

                        // response.data.List が配列かどうかを確認して処理を行う
                        if (response.data && Array.isArray(response.data.List)) {
                            this.recipes = response.data.List;
                        } else {
                            console.error('APIからのレスポンスが期待された形式ではありません:', response.data);
                        }
                    } catch (error) {
                        console.error('レシピの取得に失敗しました:', error);
                    }
                },
                async deleteRecipe() {
                    if (!this.selectedRecipe) return;

                    try {
                        // GETリクエストを送信してレシピを削除
                        const response = await axios.get('https://m3h-kouhei-2010.azurewebsites.net/api/RECIPEDELETE', {
                            params: {
                        // クエリパラメータでrecipe_idを渡す
                                recipe_id: this.selectedRecipe.recipe_id
                            }
                        });

                        // 成功メッセージを設定してダイアログを表示
                        this.message = '削除されました';
                        this.showMessageDialog = true;  // 成功メッセージダイアログを開く
                        this.dialog = false;  // 削除確認ダイアログを閉じる

                    } catch (error) {
                        // エラーメッセージを確認
                        console.error('レシピの削除に失敗しました:', error.response ? error.response.data : error.message);
                    }
                },
                selectRecipe(recipe) {
                    this.selectedRecipe = recipe;
                },
                confirmDelete(recipe) {
                    this.selectedRecipe = recipe;
                    this.dialog = true;
                },
                async closeMessageDialog() {
                    this.showMessageDialog = false;  // メッセージダイアログを閉じる
                    this.selectedRecipe = null;
                    await this.selectRecipes();  // レシピ一覧を再取得して管理画面に戻る
                },
                goBack() {
                    this.selectedRecipe = null; // 戻る際に選択したレシピをクリア
                }
            }
        });
    </script>
</body>
</html>
