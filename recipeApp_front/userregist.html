<!DOCTYPE html>
<html>
<head>
    <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font@6.x/css/materialdesignicons.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.min.css" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">
    <meta charset="UTF-8">
    <title>UserRegist</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-image: url('https://th.bing.com/th/id/OIP.gQUYX3QqXXynQkeQl4MWWAHaHr?rs=1&pid=ImgDetMain');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
        }
        .v-application {
            background-color: rgba(255, 255, 255, 0.8);
        }
        .v-container {
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        .v-btn {
            background-color: #4CAF50 !important; /* 緑色 */
            color: white !important;
        }
        .v-btn:hover {
            background-color: #388E3C !important; /* 濃い緑 */
        }
        .v-text-field label {
            color: #388E3C !important; /* フォームのラベルの色を緑に */
        }
        h1, h3 {
            color: #4CAF50; /* 緑色 */
            text-align: center;
        }
    </style>
</head>
<body>
    <div id="app">
        <v-app>
            <v-main>
                <v-container>
                    <h3>新規ユーザー登録</h3>
                    <v-form ref="form" v-model="valid">
                        <v-row>
                            <v-col cols="12" md="6">
                                <v-text-field
                                    v-model="user_name"
                                    label="ユーザー名（英数字）"
                                    :rules="userNameRules"
                                    required
                                    @input="checkUsername"
                                ></v-text-field>
                                <v-alert v-if="usernameError" type="error">{{ usernameError }}</v-alert>
                            </v-col>
                        </v-row>
                        <v-row>
                            <v-col cols="12" md="6">
                                <v-text-field
                                    v-model="password"
                                    :type="showPassword ? 'text' : 'password'"
                                    label="パスワード　8文字以上で英大小文字・数字を1つ以上含めてください"
                                    :rules="passwordRules"
                                    required
                                ></v-text-field>
                            </v-col>
                            <v-col cols="12" md="6">
                                <v-checkbox
                                    v-model="showPassword"
                                    label="パスワードを表示する"
                                ></v-checkbox>
                            </v-col>
                        </v-row>
                        <v-row>
                            <v-col cols="12" md="6">
                                <v-text-field
                                    v-model="confirmPassword"
                                    :type="showConfirmPassword ? 'text' : 'password'"
                                    label="パスワード（確認用）"
                                    :rules="confirmPasswordRules"
                                    required
                                ></v-text-field>
                            </v-col>
                            <v-col cols="12" md="6">
                                <v-checkbox
                                    v-model="showConfirmPassword"
                                    label="パスワードを表示する"
                                ></v-checkbox>
                            </v-col>
                        </v-row>
                        <v-btn :disabled="isButtonDisabled" @click="addData1">
                            登録
                        </v-btn>
                    </v-form>
                </v-container>
            </v-main>
        </v-app>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/vue@2.x/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        new Vue({
            el: '#app',
            vuetify: new Vuetify(),
            data() {
                return {
                    valid: false,
                    user_name: '',
                    password: '',
                    confirmPassword: '',
                    showPassword: false,
                    showConfirmPassword: false,
                    usernameError: '',
                    userNameRules: [
                        v => !!v || 'ユーザー名は必須です',
                        v => /^[a-zA-Z0-9]+$/.test(v) || 'ユーザー名は英数字のみを使用してください'
                    ],
                    passwordRules: [
                        v => !!v || 'パスワードは必須です',
                        v => v.length >= 8 || 'パスワードは8文字以上で入力してください',
                        v => /[A-Z]/.test(v) || 'パスワードには大文字を1つ以上含めてください',
                        v => /[0-9]/.test(v) || 'パスワードには数字を1つ以上含めてください'
                    ],
                    confirmPasswordRules: [
                        v => !!v || '確認用パスワードは必須です',
                        v => v === this.password || 'パスワードが一致しません'
                    ]
                };
            },
            methods: {
                async checkUsername() {
                    if (this.user_name.length > 0) {
                        try {
                            const response = await fetch(`https://m3h-kouhei-2010.azurewebsites.net/api/USERCHECK?user_name=${encodeURIComponent(this.user_name)}`);
                            const data = await response.json();
                            if (data.exists) {
                                this.usernameError = 'このユーザー名は既に使用されています';
                            } else {
                                this.usernameError = '';
                            }
                        } catch (error) {
                            console.error('APIエラー:', error);
                        }
                    } else {
                        this.usernameError = '';
                    }
                },
                async addData1() {
                    if (!this.$refs.form.validate() || this.usernameError) return;

                    const param = {
                        user_name: this.user_name,
                        user_password: this.password,
                    };

                    try {
                        await axios.post('https://m3h-kouhei-2010.azurewebsites.net/api/USERINSERT', param);
                        window.location.href = 'userlogin.html';
                    } catch (error) {
                        console.error('エラー:', error);
                    }
                }
            }
        });
    </script>
</body>
</html>
