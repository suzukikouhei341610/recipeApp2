<!DOCTYPE html>
<html>
  <head>
    <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font@6.x/css/materialdesignicons.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.min.css" rel="stylesheet">
    <!-- <link rel="stylesheet" href="recipe_style.css"> -->
    <link rel="stylesheet" href="headerfooter.css">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">
    <meta charset="UTF-8">
    <title>mypage</title>
    <style>
      .v-card:hover {
        cursor: pointer !important;
        background-color: #f5f5f5 !important;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2) !important; 
        transition: background-color 0.3s, box-shadow 0.3s !important;
      }

      .custom-line {
        border: 0; /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ç·šã‚’ç„¡åŠ¹ã«ã™ã‚‹ */
        border-top: 1px solid gray; /* ã‚°ãƒ¬ãƒ¼ã®ç·šã‚’ä½œæˆ */
        margin: 50px 0; /* ä¸Šä¸‹ã®ä½™ç™½ã‚’è¿½åŠ  */
        padding: 0; /* å†…å´ã®ä½™ç™½ã‚’ç„¡åŠ¹ã«ã™ã‚‹ */
        width: calc(100% - 20px); /* ä¸¡å´ã«ä½™ç™½ã‚’ä½œã‚‹ */
        margin-left: auto; /* å·¦å³ã®ä¸­å¤®æƒãˆ */
        margin-right: auto;
    }
    </style>
  </head>
    
  <body>
  <div id="app">
      <v-app>
        <v-app-bar app>
          <h1>ğŸ˜ŠãŠã¡ã‚ƒã‚‰ã‘ğŸ˜Š</h1>
          <v-spacer></v-spacer>
              <v-btn onclick="window.location.href = 'home.html';">Home</v-btn> |
              <v-btn onclick="window.location.href = 'mypage.html';">my page</v-btn> |
              <v-btn @click="logout()">logout</v-btn>
        </v-app-bar>
          <v-main>
              <v-container>
                <h1>MY PAGE</h1>
                <h3>ã“ã‚“ã«ã¡ã¯ã€{{ user_name }}ã•ã‚“ğŸ˜Š</h3>
                <hr class="custom-line">
                <h3>ãŠæ°—ã«å…¥ã‚Šä¸€è¦§</h3>

                  <!-- <v-tabs v-model="tab">
                    <v-tab>ãŠæ°—ã«å…¥ã‚Šä¸€è¦§</v-tab>
                    <v-tab>æ¤œç´¢å±¥æ­´</v-tab>
                  </v-tabs> -->
              
                  <!-- <v-tabs-items v-model="tab"> -->
                    <!-- ãŠæ°—ã«å…¥ã‚Šä¸€è¦§ -->
                    <!-- <v-tab-item> -->

                      <div v-if="dataList.length === 0">
                        ãŠæ°—ã«å…¥ã‚Šãƒ¬ã‚·ãƒ”ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚
                      </div>
                      
                      <v-row>
                          <v-col v-for="item in dataList" :key="item.recipe_id" cols="12" sm="6" md="4">
                            <v-card 
                            class="mx-auto" 
                            max-width="400" 
                            outlined
                            @click="goToDetail(item.recipe_id)"
                            >

                              <!-- <v-img
                                class="white--text align-end"
                                height="200px"
                                :src="encodeURI(recipe.recipe_photo) || 'recipeApp2\\recipeApp_front\\images\\no image.jpg'"
                                alt="Recipe Image">
                              </v-img> -->

                              <v-img
                                class="white--text align-end "
                                height="200px"
                                :src="item.recipe_photo || 'recipeApp2/recipeApp_front/images/no_image.jpg'"
                                alt="Recipe Image">
                              </v-img>
                        
                              <v-card-subtitle class="card-subtitle">
                                {{ item.recipe_name }}
                              </v-card-subtitle>
                        
                              <v-card-text class="card-recipe-time">                          
                                <div>èª¿ç†æ™‚é–“: {{ item.recipe_time }}åˆ†</div>
                              </v-card-text>
                          </v-card>
                        </v-col>
                      </v-row>
                    <!-- </v-tab-item> -->
              
                    <!-- æ¤œç´¢å±¥æ­´ -->
                    <!-- <v-tab-item>
                      <v-card flat>
                        <v-card-title>æ¤œç´¢å±¥æ­´</v-card-title>
                        <v-card-text>
                          æ¤œç´¢å±¥æ­´ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ã“ã“ã«è¿½åŠ 
                        </v-card-text>
                      </v-card>
                    </v-tab-item> -->
                  <!-- </v-tabs-items> -->
                </v-container>
          </v-main>
          <v-footer>
            <v-row class="footer-row justify-center align-center">
                <v-col class="text-center" cols="12">
                    <span class="copyright-text">Â© 2024 æ ªå¼ä¼šç¤¾ãŠã¡ã‚ƒã‚‰ã‘ All rights reserved</span>
                </v-col>
            </v-row>
        </v-footer> 
      </v-app>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script>
    new Vue({
      el: '#app',
      vuetify: new Vuetify(),
      data() {
        return {
          //tab: 0, 
          dataList: [], // ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºç”¨é…åˆ—
          // searchHistory: ['', '', ''], // ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿
          recipe: '',
          user_name: ''
        };
      },

      mounted() {
        this.fetchFavorites();   
        const user_name = sessionStorage.getItem('user_name');
        this.user_name = user_name;
      },
      
      methods: {
        async fetchFavorites() {   
          try {
            // getUserId ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã—ã¦ user_id ã‚’å–å¾—
            const user_id = await this.getUserId(); 
            console.log('user_id:', user_id);

            // user_id ã‚’å¼•æ•°ã«ã€getRecipeIds ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã—ã¦ã€recipe_ids ã‚’å–å¾—
            const recipe_ids = await this.getRecipeIds(user_id);
            console.log('recipe_ids:', recipe_ids);

            const recipe_idsParam = recipe_ids.join(",");
            console.log('recipe_idsParam:', recipe_idsParam);
            const response = await axios.post('https://m3h-kouhei-2010.azurewebsites.net/api/RECIPEJOIN', { recipe_ids: recipe_ids });
            console.log('ãƒ¬ã‚¹ãƒãƒ³ã‚¹å…¨ä½“:', response.data); 

            const favoriteRecipe = response.data;
            console.log('ãƒ¬ã‚¹ãƒãƒ³ã‚¹ result:', favoriteRecipe.result); 
            this.dataList = favoriteRecipe.result.List;
            console.log('dataList:', this.dataList); 

          } catch (error) {
            console.error('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
          }
        },

        //ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®user_nameã‹ã‚‰user_idã‚’ã¨ã£ã¦ãã‚‹
        async getUserId() {
          const user_name = sessionStorage.getItem('user_name');
          if (user_name) {
            try {
              const response = await axios.post('https://m3h-kouhei-2010.azurewebsites.net/api/LOGINIDSELECT', { user_name: user_name });
              const userIds = response.data;
              
              if (userIds.length === 0) {
                console.error('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
                return null;
              }

              const user_id = userIds[0];
              return user_id;

            } catch (error) {
              console.error('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
              return null;
            }
          } else {
            console.error('ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«user_nameãŒä¿å­˜ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
            return null;
          }
        },

        //ãŠæ°—ã«å…¥ã‚Šè¿½åŠ ã•ã‚Œã¦ã„ã‚‹recipe_id(è¤‡æ•°)ã‚’å–ã£ã¦ãã‚‹
        async getRecipeIds(user_id) {
          if (user_id) {
            try {
              // axios.post ã‚’ä½¿ç”¨ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
              const response = await axios.post('https://m3h-kouhei-2010.azurewebsites.net/api/FAVORITESELECT', { user_id });
              const favorites = response.data;
              console.log('favorites:', favorites);
              this.dataList = favorites.List;
              console.log('this.dataList:', this.dataList);
              const recipe_ids = this.dataList.map(favorite => favorite.recipe_id);
              console.log('recipe_ids:', recipe_ids);
              return recipe_ids;
            } catch (error) {
              console.error('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
            }
          } else {
            console.error('ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚');
          }
        },

        goToDetail(recipe_id){
          const url = `recipe_${recipe_id}.html`;
          window.location.href = url;
        },

        logout(){
          //console.log('User Name saved:', sessionStorage.getItem('user_name'));//ãƒ‡ãƒãƒƒã‚¯ç”¨
          sessionStorage.removeItem('user_name');
          //console.log('User Name saved:', sessionStorage.getItem('user_name'));//ãƒ‡ãƒãƒƒã‚¯ç”¨
          window.location.href = 'index.html';
        }
      }
    }
  )
  </script>
  </body>
</html>



