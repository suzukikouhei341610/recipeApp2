<!DOCTYPE html>
<html lang="ja">
<head>
  <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/@mdi/font@6.x/css/materialdesignicons.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.min.css" rel="stylesheet">
  <link rel="stylesheet" href="recipe_style.css">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ã‚«ã‚¹ãƒ†ãƒ© | ãŠè“å­ãƒ¡ãƒ¼ã‚«ãƒ¼</title>

</head>
<body>
  <div id="app">
    <v-app>
      <header>ğŸ°ãŠã¡ã‚ƒã‚‰ã‘å¤©ä½¿ã®ãŠè“å­ãƒ¬ã‚·ãƒ”ğŸ‚</header>

      <div class="title-container">
        <h1>ã‚«ã‚¹ãƒ†ãƒ©</h1>
      </div>

      <v-row class="outline">
        <v-col cols="7" class="recipe-photo">
          <img class="recipe-photo" src="https://i.pinimg.com/564x/30/28/87/3028874066174875255299e70aaccc0b.jpg" alt="ã‚«ã‚¹ãƒ†ãƒ©ã®ç”»åƒ">
        </v-col>
        <v-col cols="5">
          <div class="recipe-info">

              <v-btn
              v-if="!isFavorite"
              color="amber accent-3"
              @click="addToFavorite"
              class="favorite-btn">
                <v-icon>mdi-star-outline</v-icon>
                ãŠæ°—ã«å…¥ã‚Šã«è¿½åŠ 
              </v-btn>
  
              <v-btn
              v-else
              color="amber accent-3"
              @click="deleteFromFavorite"
              class="favorite-btn">
                <v-icon>mdi-star</v-icon>
                ãŠæ°—ã«å…¥ã‚Šã‹ã‚‰å‰Šé™¤
              </v-btn>


            <p><strong>ã‚«ãƒ†ã‚´ãƒªãƒ¼:</strong> ã¯ã¡ã¿ã¤</p>
            <p><strong>èª¿ç†æ™‚é–“:</strong> 75åˆ†</p>
            <p><strong>ä½¿ç”¨å•†å“:</strong> ãŠã¡ã‚ƒã‚‰ã‘ã¯ã¡ã¿ã¤</p>
          </div>
        </v-col>
      </v-row>

      <v-row class="details">
        <v-col cols="5" class="ingredients">

            <h2>ææ–™:</h2>
            <ul>
              <li>ã¯ã¡ã¿ã¤ å¤§ã•ã˜2</li>
              <li>ç‰›ä¹³ å¤§ã•ã˜1</li>
              <li>ã¿ã‚Šã‚“ å¤§ã•ã˜1</li>
              <li>å¼·åŠ›ç²‰ 80g</li>
              <li>åµ 2å€‹</li>
              <li>ç ‚ç³– 80g</li>
              <li>ã‚¶ãƒ©ãƒ¡ç³– å¤§ã•ã˜2</li>
            </ul>
        </v-col>

        <v-col cols="7" class="steps">
          <h2>æ‰‹é †</h2>
          <ol>
            <ul>å‹ã«ã‚ªãƒ¼ãƒ–ãƒ³ã‚·ãƒ¼ãƒˆã‚’æ•·ã„ã¦ã€ã‚¶ãƒ©ãƒ¡ã‚’æ•·ãã¤ã‚ã¦ãŠãã€‚</ul>
            <ul>å¼·åŠ›ç²‰ã‚’ãµã‚‹ã£ã¦ãŠãã€‚</ul>
            <ul>ã¯ã¡ã¿ã¤ãƒ»ç‰›ä¹³ãƒ»ã¿ã‚Šã‚“ã‚’åˆã‚ã›ã¦æ··ãœã€é›»å­ãƒ¬ãƒ³ã‚¸ï¼ˆ500Wï¼‰ã§10ç§’é–“åŠ ç†±ã€‚</ul>
            <ul>ãƒœã‚¦ãƒ«ã«åµã‚’å…¥ã‚Œã€50â„ƒç¨‹åº¦ã®æ¹¯ç…ã«ã‹ã‘ãªãŒã‚‰ã€ãã®éƒ½åº¦ã‚ˆãæ³¡ç«‹ã¦ã‚‹ã€‚</ul>
            <ul> 2.ã§åŠ ç†±ã—ãŸææ–™ã‚’åŠ ãˆã¦ã•ã‚‰ã«ã‚ˆãæ³¡ç«‹ã¦ã‚‹ã€‚</ul>
            <ul>ãµã‚‹ã£ã¦ãŠã„ãŸå¼·åŠ›ç²‰ã‚’ä¸€æ°—ã«åŠ ãˆã€ãƒ˜ãƒ©ã§åˆ‡ã‚‹ã‚ˆã†ã«æ··ãœã‚‹ã€‚</ul>
            <ul>å‹ã«æµã—å…¥ã‚Œã€2ã€œ3å›ãƒ†ãƒ¼ãƒ–ãƒ«ã«è»½ãã†ã¡ã¤ã‘ã¦ç©ºæ°—ã‚’æŠœãã€‚</ul>
            <ul>80â„ƒã«äºˆç†±ã—ãŸã‚ªãƒ¼ãƒ–ãƒ³ã§ã¾ãš10åˆ†é–“ã€ãã®å¾Œ150â„ƒã«ä¸‹ã’ã¦20åˆ†é–“ç„¼ãã€‚</ul>
            <ul>ç«¹ä¸²ã§åˆºã—ã¦ã¿ã¦ã€ç”Ÿåœ°ãŒã¤ã„ã¦ã“ãªã‘ã‚Œã°ç„¼ãä¸ŠãŒã‚Šã€‚</ul>
            <ul>å‹ã‹ã‚‰å‡ºã—ã¦ã‚ªãƒ¼ãƒ–ãƒ³ã‚·ãƒ¼ãƒˆãŒã¤ã„ãŸã¾ã¾ãƒ©ãƒƒãƒ—ã§åŒ…ã¿ã€ç„¼ãç›®ã‚’ä¸‹ã«ã—ã¦å¸¸æ¸©ã§1æ—¥å¯ã‹ã›ãŸã‚‰å®Œæˆã€‚</ul>
          </ol>
        </v-col>
      </v-row>
      
        <v-col cols="12" class="btn-col">
          <v-btn @click="navigate()" class="recipe_btn btn">æˆ»ã‚‹</v-btn>
        </v-col>
      </div>
    </v-app>
  </div>
   
  <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
 
  <script>
    new Vue({
    el: '#app',
    vuetify: new Vuetify(),
    data() {
      return {
        isFavorite: false, // åˆæœŸçŠ¶æ…‹ã¯ãŠæ°—ã«å…¥ã‚Šã§ãªã„
        nextId: null
      };
    },

    async mounted() {
      await this.checkIfFavorite();
    },

    methods: {
      // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®user_nameã‹ã‚‰user_idã‚’ã¨ã£ã¦ãã‚‹
      async getUserId() {
        const user_name = sessionStorage.getItem('user_name');
        if (user_name) {
          try {
            const loginResponse = await fetch(`https://m3h-kouhei-2010.azurewebsites.net/api/LOGINIDSELECT?user_name=${user_name}`);
            const userIds = await loginResponse.json();
            if (userIds.length === 0) {
              console.error('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
              return null;
            }
            const user_id = userIds[0];
            return user_id;
          } catch (error) {
            console.error('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
            return null;
          }
        } else {
          console.error('ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«user_nameãŒä¿å­˜ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
          return null;
        }
      },

      async readNextFavoriteId() {
        try {
          const response = await axios.get('https://m3h-kouhei-2010.azurewebsites.net/api/FAVORITEALLSELECT');
          console.log('Response:', response);
          console.log('Response data:', response.data);
          console.log('response.data.List:', response.data.List);

          if (response.data && response.data.List) {
            const ids = response.data.List.map(favoriteid => Number(favoriteid.favorite_id));
            this.nextId = ids.length ? Number(Math.max(...ids) + 1) : 1;
            console.log('Next ID:', this.nextId);
          } else {
            console.error('Unexpected response format:', response.data);
          }
        } catch (error) {
          console.error('Error fetching data:', error);
        }
      },

      async addToFavorite() {
        await this.readNextFavoriteId();
        const favorite_id = Number(this.nextId);
        const user_id = await this.getUserId();
        const recipe_id = sessionStorage.getItem("recipe_id");

        const favoritedata = {
          favorite_id: favorite_id,
          user_id: user_id,
          recipe_id: recipe_id
        }

        console.log('User ID :', user_id); // ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ­ã‚°
        console.log('Recipe ID from sessionStorage:', recipe_id); // ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ­ã‚°
        console.log('Favorite ID :', favorite_id);

        if (user_id && recipe_id) {
          try {
            const response = await axios.post("https://m3h-kouhei-2010.azurewebsites.net/api/FAVORITEINSERT", favoritedata, {
              headers: {
                "Content-Type": "application/json"
              }
            });

            if (response.status === 200) {
              console.log('ãŠæ°—ã«å…¥ã‚Šã«è¿½åŠ ã—ã¾ã—ãŸï¼');
              this.isFavorite = true; // çŠ¶æ…‹ã‚’æ›´æ–°
            } else {
              console.error('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
          } catch (error) {
            console.error("ã‚¨ãƒ©ãƒ¼:", error);
          }
        } else {
          console.error("ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã¾ãŸã¯ãƒ¬ã‚·ãƒ”IDãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚");
        }
      },

      async deleteFromFavorite() {
        const user_id = await this.getUserId();
        const recipe_id = sessionStorage.getItem("recipe_id");
        
        console.log('User ID:', user_id); // ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’è¡¨ç¤º
        console.log('Recipe ID:', recipe_id); // ãƒ¬ã‚·ãƒ”IDã‚’è¡¨ç¤º

        if (user_id && recipe_id) {
          try {
            const response = await axios.post("https://m3h-kouhei-2010.azurewebsites.net/api/FAVORITEDELETE", {
              user_id: user_id,
              recipe_id: recipe_id
            }, {
              headers: {
                "Content-Type": "application/json"
              }
            });

            if (response.status === 200) {
              console.log('ãŠæ°—ã«å…¥ã‚ŠãŒè§£é™¤ã•ã‚Œã¾ã—ãŸï¼');
              this.isFavorite = false; // çŠ¶æ…‹ã‚’æ›´æ–°
              alert('ãŠæ°—ã«å…¥ã‚ŠãŒè§£é™¤ã•ã‚Œã¾ã—ãŸã€‚');
            } else {
              console.error('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
              alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
            }
          } catch (error) {
            console.error("ã‚¨ãƒ©ãƒ¼:", error);
            alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
          }
        } else {
          console.error("ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã¾ãŸã¯ãƒ¬ã‚·ãƒ”IDãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚");
          alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã¾ãŸã¯ãƒ¬ã‚·ãƒ”IDãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚');
        }
      },

      async checkIfFavorite() {
        const user_id = await this.getUserId();
        const recipe_id = sessionStorage.getItem("recipe_id");
        
        console.log('User ID:', user_id); // ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’è¡¨ç¤º
        console.log('Recipe ID:', recipe_id); // ãƒ¬ã‚·ãƒ”IDã‚’è¡¨ç¤º

        if (user_id && recipe_id) {
        try {
          const response = await axios.get(`https://m3h-kouhei-2010.azurewebsites.net/api/CHECKIFFAVORITE?user_id=${user_id}&recipe_id=${recipe_id}`);
          const isFavorite = response.data.isFavorite;  // APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰isFavoriteã‚’å–å¾—              
          
          // ãŠæ°—ã«å…¥ã‚ŠçŠ¶æ…‹ã«å¿œã˜ã¦ãƒœã‚¿ãƒ³ã‚’åˆ‡ã‚Šæ›¿ãˆ
          this.isFavorite = isFavorite;
                console.log('ãŠæ°—ã«å…¥ã‚ŠçŠ¶æ…‹:', this.isFavorite);
              } catch (error) {
                console.error('Error checking favorite status:', error);
              }
            } else {
              console.error('ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã¾ãŸã¯ãƒ¬ã‚·ãƒ”IDãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚');
            }
          },
          navigate() {
          window.location.href = 'home.html';
        }
        }
      });
    </script>
  </body>
</html>